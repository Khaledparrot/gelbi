<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Secret Chat - Multi QR</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { background: linear-gradient(135deg, #667eea, #764ba2); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: system-ui; }
    .app-container { background: #fff; border-radius: 16px; padding: 20px; width: 100%; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .screen { display: none; }
    .active { display: block; }
    .qr-container { text-align: center; margin: 20px 0; }
    #myQr { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .qr-box { background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.2); }
    #qrReader { width: 100%; height: 280px; background: #000; border-radius: 10px; position: relative; overflow: hidden; }
    #qrGuide { position: absolute; border: 2px solid #48bb78; border-radius: 8px; width: 200px; height: 200px; top: 50%; left: 50%; transform: translate(-50%,-50%); pointer-events: none; }
    .progress { margin: 10px 0; height: 14px; background: #eee; border-radius: 8px; overflow: hidden; }
    .progress-bar { height: 100%; background: #667eea; width: 0%; transition: width 0.3s; }
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; margin: 6px 0; background: #667eea; color: #fff; font-weight: 600; cursor: pointer; }
    button:hover { background: #5a6fd8; }
    .btn-secondary { background: #a0aec0; }
    .btn-secondary:hover { background: #90a0b3; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- QR Generator -->
    <div id="qrGeneratorScreen" class="screen active">
      <h2>My Multi QR</h2>
      <p>Scan all codes in order to connect</p>
      <div class="qr-container">
        <div id="myQr"></div>
      </div>
      <button onclick="generateMyQr()">Generate QR Codes</button>
    </div>

    <!-- QR Scanner -->
    <div id="qrScannerScreen" class="screen">
      <h2>Scan Multi QR</h2>
      <div id="qrReader">
        <video playsinline autoplay muted style="width:100%;height:100%;object-fit:cover;"></video>
        <div id="qrGuide"></div>
      </div>
      <div class="progress"><div class="progress-bar" id="scanProgress"></div></div>
      <button onclick="startScanner()">Start Scanning</button>
    </div>
  </div>

<script>
let video = null;
let scanActive = false;
let currentQrParts = {};
let totalParts = 0;

// Generate multiple QR codes
function generateMyQr() {
  const data = JSON.stringify({
    type: "offer",
    sdp: "very-long-sdp-example-" + Math.random().toString(36).slice(2),
    publicKey: nacl.util.encodeBase64(nacl.randomBytes(32))
  });

  // Split into chunks
  const chunkSize = 300; // characters per QR
  const chunks = [];
  for (let i = 0; i < data.length; i += chunkSize) {
    chunks.push(data.slice(i, i + chunkSize));
  }

  const total = chunks.length;
  document.getElementById("myQr").innerHTML = "";
  chunks.forEach((chunk, i) => {
    const partData = JSON.stringify({
      part: i + 1,
      total: total,
      content: chunk
    });
    const div = document.createElement("div");
    div.className = "qr-box";
    new QRCode(div, { text: partData, width: 160, height: 160 });
    document.getElementById("myQr").appendChild(div);
  });
}

// Start scanning
async function startScanner() {
  const qrReader = document.getElementById('qrReader');
  video = qrReader.querySelector('video');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    scanActive = true;
    requestAnimationFrame(tick);
  } catch (err) {
    alert("Camera access denied.");
  }
}

// Scan loop
function tick() {
  if (!scanActive || !video || video.readyState < 2) {
    requestAnimationFrame(tick);
    return;
  }
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);
  if (code) {
    try {
      const data = JSON.parse(code.data.trim());
      if (data.part && data.total && data.content) {
        totalParts = data.total;
        currentQrParts[data.part] = data.content;

        // Update progress
        const collected = Object.keys(currentQrParts).length;
        document.getElementById("scanProgress").style.width = (collected / totalParts * 100) + "%";

        if (collected === totalParts) {
          scanActive = false;
          video.srcObject.getTracks().forEach(track => track.stop());
          const fullData = Object.keys(currentQrParts).sort((a, b) => a - b).map(k => currentQrParts[k]).join("");
          const finalObj = JSON.parse(fullData);
          alert("All QR parts scanned! Full data:\n\n" + JSON.stringify(finalObj, null, 2));
          currentQrParts = {};
          totalParts = 0;
        }
      }
    } catch (e) { console.log("QR parse error", e); }
  }
  if (scanActive) requestAnimationFrame(tick);
}
</script>
</body>
</html>
