<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure P2P Chat with Contacts</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --background-color: #f5f7fa;
            --text-color: #333;
            --message-sent: #e3f2fd;
            --message-received: #f1f1f1;
            --error-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }

        .contacts-panel {
            padding: 1rem;
            border-bottom: 1px solid #34495e;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .contact-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #34495e;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-item:hover {
            background-color: #3d566e;
        }

        .contact-item.active {
            background-color: var(--primary-color);
        }

        .contact-info {
            display: flex;
            flex-direction: column;
        }

        .contact-name {
            font-weight: bold;
        }

        .contact-status {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .online {
            background-color: var(--success-color);
        }

        .offline {
            background-color: #95a5a6;
        }

        .contact-actions {
            display: flex;
            gap: 5px;
        }

        .contact-action-btn {
            background: none;
            border: none;
            color: var(--sidebar-text);
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .contact-action-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .connection-panel {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .chat-area {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #7f8c8d;
        }

        .input-area {
            display: flex;
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        input, button, textarea {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .sent {
            background-color: var(--message-sent);
            margin-left: auto;
            text-align: right;
        }

        .received {
            background-color: var(--message-received);
        }

        .system {
            background-color: #fff3cd;
            max-width: 90%;
            margin: 0.5rem auto;
            text-align: center;
            color: #856404;
        }

        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .connected {
            background-color: var(--success-color);
            color: white;
        }

        .disconnected {
            background-color: var(--error-color);
            color: white;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        .call-btn {
            margin: 0 0.5rem;
            padding: 0.5rem 1rem;
        }

        .video-container {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .video-box {
            width: 48%;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: auto;
        }

        .hidden {
            display: none;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 0.5rem;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }

        .image-message {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: bold;
        }

        .user-id {
            font-size: 0.8rem;
            color: #bdc3c7;
        }
    </style>
</head>
<body>
    <header>
        <h1>Secure P2P Chat</h1>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-details">
                <div class="user-name" id="userName">User</div>
                <div class="user-id" id="userId">ID: <span id="userIdValue">Loading...</span></div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="contacts-panel">
                <button id="addContactBtn">Add Contact</button>
                <button id="showMyInfoBtn">My Info</button>
            </div>
            <div class="contacts-list" id="contactsList">
                <!-- Contacts will be listed here -->
            </div>
        </div>

        <div class="main-content">
            <div class="connection-panel">
                <div id="status" class="status disconnected">Disconnected</div>
                <div id="selectedContactInfo" class="hidden">
                    <div>Chat with: <span id="currentContactName">-</span></div>
                    <div>Status: <span id="currentContactStatus">-</span></div>
                </div>
                <div class="call-controls">
                    <button id="callBtn" class="call-btn" disabled>Start Call</button>
                    <button id="hangupBtn" class="call-btn" disabled>End Call</button>
                </div>
            </div>

            <div class="video-container hidden" id="videoContainer">
                <div class="video-box">
                    <video id="localVideo" autoplay muted></video>
                    <p>Local Video</p>
                </div>
                <div class="video-box">
                    <video id="remoteVideo" autoplay></video>
                    <p>Remote Video</p>
                </div>
            </div>

            <div class="chat-area" id="chatArea">
                <div class="empty-chat" id="emptyChat">
                    <h3>Select a contact to start chatting</h3>
                    <p>Your messages and calls are end-to-end encrypted</p>
                </div>
            </div>

            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <label for="fileInput" class="file-label" id="fileLabel" title="Send Image">üì∑</label>
                <button id="sendBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Contact</h3>
                <button class="close-btn" id="closeAddContactModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="contactName">Contact Name</label>
                <input type="text" id="contactName" placeholder="Enter contact name">
            </div>
            <div class="form-group">
                <label for="contactPassword">Contact Password</label>
                <input type="password" id="contactPassword" placeholder="Enter contact password">
            </div>
            <button id="saveContactBtn">Add Contact</button>
        </div>
    </div>

    <!-- My Info Modal -->
    <div class="modal" id="myInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>My Information</h3>
                <button class="close-btn" id="closeMyInfoModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="myUserName">Your Name</label>
                <input type="text" id="myUserName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label>Your User ID</label>
                <div id="myUserIdDisplay" style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;"></div>
            </div>
            <div class="form-group">
                <label>Your Password (share this to allow others to add you)</label>
                <div id="myPasswordDisplay" style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;"></div>
            </div>
            <button id="generateNewPasswordBtn">Generate New Password</button>
            <button id="saveMyInfoBtn">Save Changes</button>
        </div>
    </div>

    <script>
        // Configuration
        const SIGNALING_SERVER = 'wss://yourusername.pythonanywhere.com/ws'; // Replace with your PythonAnywhere WebSocket URL
        const ENCRYPTION_ALGORITHM = 'AES-GCM';
        const KEY_LENGTH = 256;

        // Global variables
        let ws = null;
        let peerConnection = null;
        let dataChannel = null;
        let localStream = null;
        let remoteStream = null;
        let encryptionKey = null;
        let currentRoomId = '';
        let isInitiator = false;
        let currentContact = null;
        let contacts = [];
        let userInfo = {};
        let conversations = {};

        // DOM elements
        const statusEl = document.getElementById('status');
        const contactsList = document.getElementById('contactsList');
        const chatArea = document.getElementById('chatArea');
        const emptyChat = document.getElementById('emptyChat');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const videoContainer = document.getElementById('videoContainer');
        const callBtn = document.getElementById('callBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const addContactBtn = document.getElementById('addContactBtn');
        const showMyInfoBtn = document.getElementById('showMyInfoBtn');
        const addContactModal = document.getElementById('addContactModal');
        const myInfoModal = document.getElementById('myInfoModal');
        const closeAddContactModal = document.getElementById('closeAddContactModal');
        const closeMyInfoModal = document.getElementById('closeMyInfoModal');
        const saveContactBtn = document.getElementById('saveContactBtn');
        const saveMyInfoBtn = document.getElementById('saveMyInfoBtn');
        const generateNewPasswordBtn = document.getElementById('generateNewPasswordBtn');
        const contactNameInput = document.getElementById('contactName');
        const contactPasswordInput = document.getElementById('contactPassword');
        const myUserNameInput = document.getElementById('myUserName');
        const myUserIdDisplay = document.getElementById('myUserIdDisplay');
        const myPasswordDisplay = document.getElementById('myPasswordDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userIdValue = document.getElementById('userIdValue');
        const selectedContactInfo = document.getElementById('selectedContactInfo');
        const currentContactName = document.getElementById('currentContactName');
        const currentContactStatus = document.getElementById('currentContactStatus');

        // Initialize application
        function init() {
            loadUserInfo();
            loadContacts();
            loadConversations();
            connectWebSocket();
            setupEventListeners();
            updateUI();
        }

        // Load user info from localStorage
        function loadUserInfo() {
            const savedUserInfo = localStorage.getItem('secureChatUserInfo');
            if (savedUserInfo) {
                userInfo = JSON.parse(savedUserInfo);
            } else {
                // Generate new user info
                userInfo = {
                    id: generateUserId(),
                    name: 'User',
                    password: generatePassword()
                };
                saveUserInfo();
            }
            
            updateUserInfoDisplay();
        }

        // Generate a unique user ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // Generate a random password
        function generatePassword() {
            return Math.random().toString(36).substr(2, 12);
        }

        // Save user info to localStorage
        function saveUserInfo() {
            localStorage.setItem('secureChatUserInfo', JSON.stringify(userInfo));
            updateUserInfoDisplay();
        }

        // Update user info display
        function updateUserInfoDisplay() {
            userAvatar.textContent = userInfo.name.charAt(0).toUpperCase();
            userName.textContent = userInfo.name;
            userIdValue.textContent = userInfo.id;
            myUserNameInput.value = userInfo.name;
            myUserIdDisplay.textContent = userInfo.id;
            myPasswordDisplay.textContent = userInfo.password;
        }

        // Load contacts from localStorage
        function loadContacts() {
            const savedContacts = localStorage.getItem('secureChatContacts');
            if (savedContacts) {
                contacts = JSON.parse(savedContacts);
            }
            renderContacts();
        }

        // Save contacts to localStorage
        function saveContacts() {
            localStorage.setItem('secureChatContacts', JSON.stringify(contacts));
            renderContacts();
        }

        // Load conversations from localStorage
        function loadConversations() {
            const savedConversations = localStorage.getItem('secureChatConversations');
            if (savedConversations) {
                conversations = JSON.parse(savedConversations);
            }
        }

        // Save conversations to localStorage
        function saveConversations() {
            localStorage.setItem('secureChatConversations', JSON.stringify(conversations));
        }

        // Render contacts list
        function renderContacts() {
            contactsList.innerHTML = '';
            
            if (contacts.length === 0) {
                contactsList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #bdc3c7;">No contacts yet</div>';
                return;
            }
            
            contacts.forEach(contact => {
                const contactEl = document.createElement('div');
                contactEl.className = `contact-item ${currentContact && currentContact.id === contact.id ? 'active' : ''}`;
                contactEl.innerHTML = `
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status">
                            <span class="status-indicator ${contact.online ? 'online' : 'offline'}"></span>
                            ${contact.online ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="contact-action-btn delete-contact" data-id="${contact.id}" title="Delete Contact">üóëÔ∏è</button>
                    </div>
                `;
                
                contactEl.addEventListener('click', () => selectContact(contact));
                contactsList.appendChild(contactEl);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-contact').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const contactId = btn.getAttribute('data-id');
                    deleteContact(contactId);
                });
            });
        }

        // Add a new contact
        function addContact(name, password) {
            // In a real app, you would verify the password with the contact's user info
            // For this demo, we'll just create a contact with the provided info
            
            const newContact = {
                id: 'contact_' + Math.random().toString(36).substr(2, 9),
                name: name,
                password: password, // In a real app, you wouldn't store the password
                online: false,
                publicKey: null // In a real app, you would exchange public keys for encryption
            };
            
            contacts.push(newContact);
            saveContacts();
            
            // Initialize conversation for this contact
            if (!conversations[newContact.id]) {
                conversations[newContact.id] = [];
                saveConversations();
            }
            
            closeModal(addContactModal);
            contactNameInput.value = '';
            contactPasswordInput.value = '';
        }

        // Delete a contact
        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact?')) {
                contacts = contacts.filter(contact => contact.id !== contactId);
                
                if (currentContact && currentContact.id === contactId) {
                    currentContact = null;
                    updateUI();
                }
                
                saveContacts();
            }
        }

        // Select a contact to chat with
        function selectContact(contact) {
            currentContact = contact;
            updateUI();
            loadConversation(contact.id);
            
            // Update contact status (in a real app, this would come from the server)
            updateContactStatus(contact.id, true);
        }

        // Update contact status
        function updateContactStatus(contactId, online) {
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                contact.online = online;
                saveContacts();
                
                if (currentContact && currentContact.id === contactId) {
                    currentContactStatus.textContent = online ? 'Online' : 'Offline';
                }
            }
        }

        // Load conversation for a contact
        function loadConversation(contactId) {
            chatArea.innerHTML = '';
            emptyChat.classList.add('hidden');
            
            const conversation = conversations[contactId] || [];
            
            if (conversation.length === 0) {
                chatArea.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #7f8c8d;">
                        <h3>No messages yet</h3>
                        <p>Start a conversation with ${currentContact.name}</p>
                    </div>
                `;
                return;
            }
            
            conversation.forEach(msg => {
                addMessageToChat(msg.sender, msg.content, msg.type, false);
            });
        }

        // Add message to chat area
        function addMessageToChat(sender, content, type, saveToHistory = true) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            if (type === 'image') {
                messageEl.innerHTML = `
                    <strong>${sender}:</strong>
                    <img src="${content}" class="image-message" alt="Shared image">
                `;
            } else {
                messageEl.innerHTML = `<strong>${sender}:</strong> ${content}`;
            }
            
            chatArea.appendChild(messageEl);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // Save to conversation history
            if (saveToHistory && currentContact) {
                if (!conversations[currentContact.id]) {
                    conversations[currentContact.id] = [];
                }
                
                conversations[currentContact.id].push({
                    sender: sender,
                    content: content,
                    type: type,
                    timestamp: new Date().toISOString()
                });
                
                saveConversations();
            }
        }

        // Update UI based on current state
        function updateUI() {
            if (currentContact) {
                selectedContactInfo.classList.remove('hidden');
                currentContactName.textContent = currentContact.name;
                currentContactStatus.textContent = currentContact.online ? 'Online' : 'Offline';
                messageInput.disabled = false;
                sendBtn.disabled = false;
                callBtn.disabled = !currentContact.online;
                emptyChat.classList.add('hidden');
            } else {
                selectedContactInfo.classList.add('hidden');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                callBtn.disabled = true;
                emptyChat.classList.remove('hidden');
            }
            
            renderContacts();
        }

        // WebSocket connection
        function connectWebSocket() {
            try {
                ws = new WebSocket(SIGNALING_SERVER);
                
                ws.onopen = () => {
                    updateStatus('Connected to signaling server', 'connected');
                };
                
                ws.onclose = () => {
                    updateStatus('Disconnected from signaling server', 'disconnected');
                    // Mark all contacts as offline
                    contacts.forEach(contact => {
                        contact.online = false;
                    });
                    saveContacts();
                    updateUI();
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('Connection error', 'disconnected');
                };
                
                ws.onmessage = handleSignalingMessage;
            } catch (error) {
                console.error('Failed to connect to signaling server:', error);
                updateStatus('Connection failed', 'disconnected');
            }
        }

        // Handle signaling messages
        function handleSignalingMessage(event) {
            const message = JSON.parse(event.data);
            
            switch (message.type) {
                case 'room_joined':
                    handleRoomJoined(message);
                    break;
                case 'user_joined':
                    handleUserJoined(message);
                    break;
                case 'offer':
                    handleOffer(message);
                    break;
                case 'answer':
                    handleAnswer(message);
                    break;
                case 'ice_candidate':
                    handleIceCandidate(message);
                    break;
                case 'error':
                    handleError(message);
                    break;
            }
        }

        // Join room with a contact
        function joinRoomWithContact(contact) {
            if (!contact) return;
            
            currentRoomId = `${userInfo.id}_${contact.id}`.split('').sort().join('');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'join',
                    room_id: currentRoomId,
                    user_id: userInfo.id
                }));
            }
        }

        // Handle room joined
        function handleRoomJoined(message) {
            updateStatus(`In room with ${currentContact.name}`, 'connected');
            
            // Generate encryption key for this session
            generateEncryptionKey();
            
            // Check if we're the first user in the room
            isInitiator = message.is_initiator;
            
            if (isInitiator) {
                addMessageToChat('System', 'Secure connection established. You can now send messages.', 'system');
            }
        }

        // Handle user joined
        function handleUserJoined(message) {
            updateContactStatus(currentContact.id, true);
            addMessageToChat('System', `${currentContact.name} is online`, 'system');
            
            // If we're the initiator, create an offer
            if (isInitiator) {
                createOffer();
            }
        }

        // Generate encryption key
        async function generateEncryptionKey() {
            try {
                encryptionKey = await window.crypto.subtle.generateKey(
                    {
                        name: ENCRYPTION_ALGORITHM,
                        length: KEY_LENGTH,
                    },
                    true,
                    ['encrypt', 'decrypt']
                );
                
                console.log('Encryption key generated');
            } catch (error) {
                console.error('Failed to generate encryption key:', error);
            }
        }

        // Encrypt data
        async function encryptData(data) {
            try {
                const encoder = new TextEncoder();
                const encodedData = encoder.encode(data);
                
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                
                const encryptedData = await window.crypto.subtle.encrypt(
                    {
                        name: ENCRYPTION_ALGORITHM,
                        iv: iv
                    },
                    encryptionKey,
                    encodedData
                );
                
                // Combine IV and encrypted data
                const combined = new Uint8Array(iv.length + encryptedData.byteLength);
                combined.set(iv);
                combined.set(new Uint8Array(encryptedData), iv.length);
                
                // Convert to base64 for transmission
                return btoa(String.fromCharCode(...combined));
            } catch (error) {
                console.error('Encryption failed:', error);
                return null;
            }
        }

        // Decrypt data
        async function decryptData(encryptedData) {
            try {
                // Convert from base64
                const binaryData = atob(encryptedData);
                const combined = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    combined[i] = binaryData.charCodeAt(i);
                }
                
                // Extract IV and encrypted data
                const iv = combined.slice(0, 12);
                const data = combined.slice(12);
                
                const decryptedData = await window.crypto.subtle.decrypt(
                    {
                        name: ENCRYPTION_ALGORITHM,
                        iv: iv
                    },
                    encryptionKey,
                    data
                );
                
                const decoder = new TextDecoder();
                return decoder.decode(decryptedData);
            } catch (error) {
                console.error('Decryption failed:', error);
                return null;
            }
        }

        // Create WebRTC peer connection
        function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // Handle incoming remote stream
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                remoteVideo.srcObject = remoteStream;
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignalingMessage({
                        type: 'ice_candidate',
                        candidate: event.candidate
                    });
                }
            };
            
            // Create data channel for messaging
            if (isInitiator) {
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }
        }

        // Setup data channel
        function setupDataChannel() {
            dataChannel.onopen = () => {
                addMessageToChat('System', 'Secure connection established', 'system');
            };
            
            dataChannel.onmessage = async (event) => {
                try {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'text') {
                        const decryptedText = await decryptData(message.data);
                        if (decryptedText) {
                            addMessageToChat(currentContact.name, decryptedText, 'received');
                        }
                    } else if (message.type === 'image') {
                        const decryptedData = await decryptData(message.data);
                        if (decryptedData) {
                            addMessageToChat(currentContact.name, decryptedData, 'received', 'image');
                        }
                    }
                } catch (error) {
                    console.error('Error processing incoming message:', error);
                }
            };
        }

        // Create offer
        async function createOffer() {
            try {
                createPeerConnection();
                
                // Add local stream if available
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });
                }
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                sendSignalingMessage({
                    type: 'offer',
                    offer: offer
                });
            } catch (error) {
                console.error('Error creating offer:', error);
            }
        }

        // Handle offer
        async function handleOffer(message) {
            try {
                createPeerConnection();
                
                // Add local stream if available
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });
                }
                
                await peerConnection.setRemoteDescription(message.offer);
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                sendSignalingMessage({
                    type: 'answer',
                    answer: answer
                });
            } catch (error) {
                console.error('Error handling offer:', error);
            }
        }

        // Handle answer
        async function handleAnswer(message) {
            try {
                await peerConnection.setRemoteDescription(message.answer);
            } catch (error) {
                console.error('Error handling answer:', error);
            }
        }

        // Handle ICE candidate
        async function handleIceCandidate(message) {
            try {
                await peerConnection.addIceCandidate(message.candidate);
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        }

        // Start call
        async function startCall() {
            if (!currentContact) return;
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                localVideo.srcObject = localStream;
                videoContainer.classList.remove('hidden');
                
                callBtn.disabled = true;
                hangupBtn.disabled = false;
                
                // Join room with contact
                joinRoomWithContact(currentContact);
                
                if (isInitiator) {
                    createOffer();
                }
            } catch (error) {
                console.error('Error accessing media devices:', error);
                alert('Could not access camera/microphone');
            }
        }

        // End call
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            videoContainer.classList.add('hidden');
            
            callBtn.disabled = false;
            hangupBtn.disabled = true;
            
            addMessageToChat('System', 'Call ended', 'system');
        }

        // Send message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !dataChannel || dataChannel.readyState !== 'open' || !currentContact) {
                return;
            }
            
            try {
                const encryptedText = await encryptData(text);
                if (encryptedText) {
                    dataChannel.send(JSON.stringify({
                        type: 'text',
                        data: encryptedText
                    }));
                    
                    addMessageToChat('You', text, 'sent');
                    messageInput.value = '';
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Send image
        async function sendImage(file) {
            if (!file || !dataChannel || dataChannel.readyState !== 'open' || !currentContact) {
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const imageData = event.target.result;
                    const encryptedImage = await encryptData(imageData);
                    
                    if (encryptedImage) {
                        dataChannel.send(JSON.stringify({
                            type: 'image',
                            data: encryptedImage
                        }));
                        
                        addMessageToChat('You', imageData, 'sent', 'image');
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error sending image:', error);
            }
        }

        // Update status
        function updateStatus(text, statusClass) {
            statusEl.textContent = text;
            statusEl.className = `status ${statusClass}`;
        }

        // Send signaling message
        function sendSignalingMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                message.room_id = currentRoomId;
                ws.send(JSON.stringify(message));
            }
        }

        // Handle errors
        function handleError(message) {
            alert(`Error: ${message.message}`);
        }

        // Modal functions
        function openModal(modal) {
            modal.style.display = 'flex';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Contact management
            addContactBtn.addEventListener('click', () => openModal(addContactModal));
            showMyInfoBtn.addEventListener('click', () => openModal(myInfoModal));
            
            closeAddContactModal.addEventListener('click', () => closeModal(addContactModal));
            closeMyInfoModal.addEventListener('click', () => closeModal(myInfoModal));
            
            saveContactBtn.addEventListener('click', () => {
                const name = contactNameInput.value.trim();
                const password = contactPasswordInput.value.trim();
                
                if (!name || !password) {
                    alert('Please enter both name and password');
                    return;
                }
                
                addContact(name, password);
            });
            
            saveMyInfoBtn.addEventListener('click', () => {
                const name = myUserNameInput.value.trim();
                
                if (!name) {
                    alert('Please enter your name');
                    return;
                }
                
                userInfo.name = name;
                saveUserInfo();
                closeModal(myInfoModal);
            });
            
            generateNewPasswordBtn.addEventListener('click', () => {
                userInfo.password = generatePassword();
                saveUserInfo();
            });
            
            // Chat functionality
            callBtn.addEventListener('click', startCall);
            hangupBtn.addEventListener('click', endCall);
            
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    sendImage(e.target.files[0]);
                    e.target.value = ''; // Reset file input
                }
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === addContactModal) {
                    closeModal(addContactModal);
                }
                if (e.target === myInfoModal) {
                    closeModal(myInfoModal);
                }
            });
        }

        // Initialize the application
        init();
    </script>
</body>
</html>
