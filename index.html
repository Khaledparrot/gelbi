<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Minimal P2P Chat</title>
</head>
<body style="display:flex;flex-direction:column;align-items:center;font-family:sans-serif;">
<h2>P2P Chat</h2>

<div>
  <input id="password" type="password" placeholder="Shared password">
  <button id="startBtn">Start</button>
</div>

<!-- QR / Scan section -->
<div id="qrBox" style="display:none;text-align:center;">
  <p id="qrLabel"></p>
  <div id="qr"></div>
  <button id="nextBtn" style="display:none;">Next QR</button>
  <button id="scanBtn">Scan</button>
  <video id="video" style="width:240px;display:none;"></video>
</div>

<!-- Chat UI -->
<div id="chat" style="display:none;width:90%;max-width:400px;">
  <div id="msgs" style="border:1px solid #ccc;height:200px;overflow:auto;margin:5px;padding:5px;"></div>
  <input id="msg" style="width:75%;" placeholder="Message">
  <button id="send">Send</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
const pw=document.getElementById('password');
const startBtn=document.getElementById('startBtn');
const qrBox=document.getElementById('qrBox');
const qrDiv=document.getElementById('qr');
const nextBtn=document.getElementById('nextBtn');
const scanBtn=document.getElementById('scanBtn');
const label=document.getElementById('qrLabel');
const chat=document.getElementById('chat');
const msgs=document.getElementById('msgs');
const msg=document.getElementById('msg');
const send=document.getElementById('send');
const video=document.getElementById('video');

let pc,dc,password;
let parts=[], index=0;

async function keyFromPw(p){
  const enc=new TextEncoder().encode(p);
  const km=await crypto.subtle.importKey("raw",enc,{name:"PBKDF2"},false,["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt:enc,iterations:1e5,hash:"SHA-256"},
         km,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function encText(t){
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const k=await keyFromPw(password);
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},k,new TextEncoder().encode(t));
  return btoa(JSON.stringify({iv:Array.from(iv),ct:Array.from(new Uint8Array(ct))}));
}
async function decText(t){
  const {iv,ct}=JSON.parse(atob(t));
  const k=await keyFromPw(password);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(iv)},k,new Uint8Array(ct));
  return new TextDecoder().decode(pt);
}
function addMsg(t,me=false){
  const d=document.createElement('div');
  d.textContent=(me?"Me: ":"Peer: ")+t;
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}
function showQrParts(pieces){
  parts=pieces; index=0;
  qrDiv.innerHTML="";
  nextBtn.style.display= parts.length>1?"inline":"none";
  drawCurrent();
}
function drawCurrent(){
  qrDiv.innerHTML="";
  label.textContent=`QR ${index+1} / ${parts.length}`;
  new QRCode(qrDiv,{text:parts[index],width:200,height:200});
}
nextBtn.onclick=()=>{ if(++index<parts.length) drawCurrent(); };

function split4(s){
  const sz=Math.ceil(s.length/4),out=[];
  for(let i=0;i<4;i++) out.push(s.slice(i*sz,(i+1)*sz));
  return out;
}

async function makeOffer(){
  pc=new RTCPeerConnection();
  dc=pc.createDataChannel("c");
  dc.onmessage=async e=>addMsg(await decText(e.data));
  const off=await pc.createOffer();
  await pc.setLocalDescription(off);
  return btoa(JSON.stringify(off));
}

startBtn.onclick=async()=>{
  password=pw.value;
  if(!password){alert("enter password");return;}
  const offer64=await makeOffer();
  qrBox.style.display="block";
  showQrParts(split4(offer64));
};

scanBtn.onclick=()=>startScan(async full=>{
  if(!pc){ // joining peer
    password=pw.value;
    pc=new RTCPeerConnection();
    pc.ondatachannel=e=>{
      dc=e.channel;
      dc.onmessage=async ev=>addMsg(await decText(ev.data));
    };
    const off=JSON.parse(atob(full));
    await pc.setRemoteDescription(off);
    const ans=await pc.createAnswer();
    await pc.setLocalDescription(ans);
    showQrParts(split4(btoa(JSON.stringify(ans))));
    // allow first peer to scan answer next
  } else { // first peer scanning answer
    const ans=JSON.parse(atob(full));
    await pc.setRemoteDescription(ans);
    chat.style.display="block";
    qrBox.style.display="none";
  }
});

function startScan(done){
  let chunks=[];
  video.style.display="block";
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(stream=>{
    video.srcObject=stream;video.play();
    const canvas=document.createElement('canvas');
    const scan=()=>{
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth;canvas.height=video.videoHeight;
        const ctx=canvas.getContext("2d");
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const img=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(img.data,canvas.width,canvas.height);
        if(code && !chunks.includes(code.data)){
          chunks.push(code.data);
          alert(`Scanned ${chunks.length}/4`);
          if(chunks.length===4){
            stream.getTracks().forEach(t=>t.stop());
            video.style.display="none";
            done(chunks.join(""));
            return;
          }
        }
      }
      requestAnimationFrame(scan);
    };
    scan();
  });
}

send.onclick=async()=>{
  if(!msg.value||!dc) return;
  dc.send(await encText(msg.value));
  addMsg(msg.value,true);
  msg.value="";
};
</script>
</body>
</html>
